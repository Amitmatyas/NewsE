<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>טיטוס - התרעות בזמן אמת</title>
    <link rel="icon" href="https://i.postimg.cc/3r45Jr7M/13.png" type="image/png" />

    <link href="https://fonts.googleapis.com/css?family=Assistant:400,700&display=swap" rel="stylesheet">

    <style>
      /* --- כללי ואיפוס --- */
      body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden; /* מונע פסי גלילה */
        font-family: 'Assistant', sans-serif;
        background-color: #0d0d0d; /* רקע שחור עמוק */
        color: #f0f0f0; /* טקסט בהיר */
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative; /* עבור שכבות אנימציה */
      }

      /* --- מסך טעינה / פתיחה --- */
      .splash-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: #0d0d0d; /* שחור כהה */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000; /* וודא שהוא מעל הכל */
        opacity: 1;
        /* transition: opacity 1s ease-out; -- אנימציית ההתפוגגות תטופל בקלאס hidden */
      }

      .splash-logo {
        width: 150px;
        height: 150px;
        animation: pulseAndGrow 2s infinite ease-in-out; /* רק פעימה וגדילה */
      }

      @keyframes pulseAndGrow {
        0% { transform: scale(0.8); opacity: 0.5; }
        50% { transform: scale(1.1); opacity: 1; }
        100% { transform: scale(0.8); opacity: 0.5; }
      }

      /* קלאס חדש להסתרת הספלאש עם אנימציה */
      .splash-screen.hidden {
        opacity: 0;
        transition: opacity 0.5s ease-out; /* זמן מעבר קצר יותר */
        pointer-events: none; /* מונע אינטראקציה אחרי שהתפוגג */
      }

      /* --- מיכל ראשי לאתר --- */
      .full-screen-container {
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: #0d0d0d; /* רקע שחור כהה */
        padding: 20px;
        box-sizing: border-box;
        opacity: 0; /* נסתר בהתחלה */
        transform: translateY(50px);
        transition: opacity 1s ease-out, transform 1s ease-out; /* אנימציית כניסה */
      }

      .full-screen-container.visible {
        opacity: 1;
        transform: translateY(0);
      }

      /* --- כותרת ולוגו ראשיים --- */
      .alert-header {
        display: flex;
        flex-direction: column; /* הלוגו מעל הכותרת */
        align-items: center;
        margin-bottom: 40px;
        animation: fadeInDown 1s ease-out forwards;
      }

      .main-logo { /* קלאס חדש ללוגו הגדול למעלה */
        width: 120px; /* גודל גדול יותר */
        height: 120px;
        margin-bottom: 15px; /* מרווח בין הלוגו לכותרת */
        animation: rotateIn 1s ease-out forwards; /* אנימציית סיבוב */
      }

      @keyframes rotateIn {
        from { transform: rotateY(90deg) scale(0.5); opacity: 0; }
        to { transform: rotateY(0deg) scale(1); opacity: 1; }
      }

      .header-title {
        font-size: 3.8em;
        font-weight: 700;
        color: #e74c3c;
        /* הסרת הצל המכוער - רק זוהר עדין */
        text-shadow: 0 0 10px rgba(231, 76, 60, 0.5); 
        letter-spacing: 3px;
        animation: neonGlow 1.5s infinite alternate; /* אנימציית ניאון */
      }

      @keyframes neonGlow {
        from { text-shadow: 0 0 5px #e74c3c, 0 0 10px #e74c3c, 0 0 15px #e74c3c; } /* זוהר עדין */
        to { text-shadow: 0 0 8px #e74c3c, 0 0 16px #e74c3c, 0 0 24px #e74c3c; } /* זוהר עדין יותר בהבהוב */
      }

      /* --- רשימת התרעות --- */
      .alerts-list {
        list-style: none;
        padding: 0;
        margin: 0;
        width: 90%;
        max-width: 1000px;
        text-align: center;
        perspective: 1000px;
      }

      /* --- פריט התרעה בודד (אדום) --- */
      .alert-item.active {
        background-color: #e74c3c; /* אדום בוהק */
        color: white;
        padding: 25px 40px;
        margin-bottom: 25px;
        border-radius: 15px;
        font-size: 3em;
        font-weight: 700;
        box-shadow: 0 0 30px rgba(231, 76, 60, 0.9), 0 0 50px rgba(231, 76, 60, 0.6);
        border: 4px solid #f9f9f9;
        animation: slideInFromRight 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards,
                   pulseRed 2s infinite;
        transform-origin: center center;
        position: relative;
        overflow: hidden;
      }

      /* --- מלבן "אין התרעות" (ירוק) --- */
      .no-alerts-message {
        background-color: #27ae60; /* ירוק */
        color: white;
        padding: 25px 40px;
        margin-bottom: 25px;
        border-radius: 15px;
        font-size: 2.5em; /* קצת קטן יותר מהתרעה פעילה */
        font-weight: 700;
        box-shadow: 0 0 20px rgba(39, 174, 96, 0.7), 0 0 30px rgba(39, 174, 96, 0.4);
        border: 4px solid #f9f9f9;
        animation: fadeIn 1s ease-out forwards, pulseGreen 2s infinite; /* אנימציית כניסה והבהוב ירוק */
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes pulseGreen {
        0% { box-shadow: 0 0 20px rgba(39, 174, 96, 0.7), 0 0 30px rgba(39, 174, 96, 0.4); transform: scale(1); }
        50% { box-shadow: 0 0 30px rgba(39, 174, 96, 0.9), 0 0 45px rgba(39, 174, 96, 0.6); transform: scale(1.02); }
        100% { box-shadow: 0 0 20px rgba(39, 174, 96, 0.7), 0 0 30px rgba(39, 174, 96, 0.4); transform: scale(1); }
      }

      .alert-item:last-child {
        margin-bottom: 0;
      }

      .alert-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* --- אנימציות --- */
      @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-80px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @keyframes slideInFromRight {
        from { opacity: 0; transform: translateX(100%) scale(0.8); }
        to { opacity: 1; transform: translateX(0) scale(1); }
      }

      @keyframes fadeOutAndShrink {
        from { opacity: 1; transform: scale(1); }
        to { opacity: 0; transform: scale(0.9) translateY(-20px); }
      }

      @keyframes pulseRed {
        0% { box-shadow: 0 0 30px rgba(231, 76, 60, 0.9), 0 0 50px rgba(231, 76, 60, 0.6); transform: scale(1); }
        50% { box-shadow: 0 0 45px rgba(231, 76, 60, 1), 0 0 70px rgba(231, 76, 60, 0.8); transform: scale(1.02); }
        100% { box-shadow: 0 0 30px rgba(231, 76, 60, 0.9), 0 0 50px rgba(231, 76, 60, 0.6); transform: scale(1); }
      }

      /* --- כפתור היסטוריה --- */
      .history-button {
        position: absolute; /* מיקום קבוע בפינה */
        top: 20px;
        right: 20px;
        background-color: #34495e; /* כחול כהה/אפור */
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: 10px;
        font-size: 1.2em;
        font-weight: 700;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        z-index: 999; /* מעל שאר התוכן אבל מתחת לספלאש */
        opacity: 0; /* נסתר בהתחלה */
        transform: translateY(-50px);
        transition: opacity 1s ease-out, transform 1s ease-out; /* אנימציית כניסה (ללא דיליי) */
      }

      .history-button.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .history-button:hover {
        background-color: #2c3e50;
        transform: translateY(-2px);
      }

      /* --- חלון היסטוריה מודאלי --- */
      .history-modal {
        display: none; /* נסתר כברירת מחדל */
        position: fixed;
        z-index: 1001; /* מעל הכל, כולל ספלאש */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8); /* רקע שחור שקוף */
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease-out;
      }

      .history-modal-content {
        background-color: #1a1a1a; /* רקע כהה למודאל */
        margin: auto;
        padding: 30px;
        border: 1px solid #333;
        border-radius: 15px;
        width: 80%;
        max-width: 700px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        position: relative;
        animation: slideInTop 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      }

      @keyframes slideInTop {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }

      .close-button {
        color: #aaa;
        float: left; /* מיקום בצד שמאל */
        font-size: 35px;
        font-weight: bold;
        transition: color 0.3s ease;
      }

      .close-button:hover,
      .close-button:focus {
        color: #e74c3c;
        text-decoration: none;
        cursor: pointer;
      }

      .modal-title {
        text-align: center;
        color: #e74c3c;
        font-size: 2.5em;
        margin-bottom: 20px;
        font-weight: 700;
      }

      .history-list {
        list-style: none;
        padding: 0;
        max-height: 400px; /* גלילה אם יש הרבה פריטים */
        overflow-y: auto;
        border: 1px solid #333;
        border-radius: 8px;
        background-color: #0d0d0d;
      }

      .history-list li {
        padding: 15px 20px;
        border-bottom: 1px solid #222;
        font-size: 1.1em;
        color: #f0f0f0;
        text-align: right; /* יישור לימין */
      }

      .history-list li:last-child {
        border-bottom: none;
      }

      .history-list li span {
        font-weight: 700;
        color: #e74c3c;
      }

      /* --- התאמות רספונסיביות --- */
      @media (max-width: 1200px) {
        .main-logo { width: 100px; height: 100px; }
        .header-title { font-size: 3em; }
        .alert-item.active { font-size: 2.5em; padding: 20px 30px; }
        .no-alerts-message { font-size: 2em; padding: 20px 30px; }
      }

      @media (max-width: 768px) {
        .main-logo { width: 80px; height: 80px; }
        .header-title { font-size: 2em; }
        .alert-item.active { font-size: 1.8em; padding: 15px 25px; }
        .no-alerts-message { font-size: 1.5em; padding: 15px 25px; }
        .history-button { font-size: 1em; padding: 10px 20px; top: 15px; right: 15px; }
        .modal-title { font-size: 2em; }
        .history-list li { font-size: 1em; padding: 12px 15px; }
      }

      @media (max-width: 480px) {
        .main-logo { width: 60px; height: 60px; }
        .header-title { font-size: 1.5em; }
        .alert-item.active { font-size: 1.3em; padding: 10px 15px; }
        .no-alerts-message { font-size: 1.2em; padding: 10px 15px; }
        .history-button { font-size: 0.9em; padding: 8px 15px; top: 10px; right: 10px; }
        .modal-title { font-size: 1.8em; }
        .history-list li { font-size: 0.9em; padding: 10px 12px; }
      }
    </style>
  </head>
  <body>
    <div class="splash-screen" id="splash-screen">
      <img src="https://i.postimg.cc/3r45Jr7M/13.png" alt="טיטוס לוגו" class="splash-logo" />
    </div>

    <div class="full-screen-container" id="full-screen-container">
      <button class="history-button" id="history-button">היסטוריית התרעות (שעה אחורה)</button>

      <div class="alert-header">
        <img src="https://i.postimg.cc/3r45Jr7M/13.png" alt="טיטוס לוגו" class="main-logo" />
        <h1 class="header-title">טיטוס - התרעות בזמן אמת</h1>
      </div>
      <ul class="alerts-list" id="alerts-list">
        </ul>
    </div>

    <div id="historyModal" class="history-modal">
      <div class="history-modal-content">
        <span class="close-button" id="closeHistoryModal">&times;</span>
        <h2 class="modal-title">היסטוריית התרעות (שעה אחרונה)</h2>
        <ul id="history-list" class="history-list">
          <li style="text-align: center; color: #aaa;">אין התרעות בשעה האחרונה.</li>
        </ul>
      </div>
    </div>

    <script>
      const ALERTS_API_URL = "/api/notifications"; // מופנה לפרוקסי ב-Netlify
      const UPDATE_INTERVAL_MS = 1000; // כל 1 שנייה
      const MAX_ALERTS_DISPLAY = 3; // מספר ההתרעות המקסימלי שיוצגו
      const HISTORY_LOOKBACK_HOURS = 1; // שעות אחורה להיסטוריה
      const SPLASH_SCREEN_DURATION_MS = 2500; // משך זמן מסך הפתיחה

      const splashScreen = document.getElementById("splash-screen");
      const fullScreenContainer = document.getElementById("full-screen-container");
      const historyButton = document.getElementById("history-button");
      const alertsList = document.getElementById("alerts-list");
      const historyModal = document.getElementById("historyModal");
      const closeHistoryModalButton = document.getElementById("closeHistoryModal");
      const historyList = document.getElementById("history-list");

      let displayedAlerts = new Map(); // מפה של notificationId ל-DOM element
      let allFetchedAlerts = []; // שומר את כל ההתרעות שנקלטו (לצורך היסטוריה)

      // ממפה מספרי איום לתיאורים מובנים
      const THREAT_MAP = {
        1: "ירי קטיושות",
        2: "חדירת כלי טיס עוין",
        3: "רעידת אדמה",
        4: "אירוע חומרים מסוכנים",
        5: "ירי רקטות וטילים",
        6: "צונאמי",
        7: "שטפונות",
        8: "שריפה",
        9: "אחר",
      };

      /**
       * ממיר חותמת זמן UNIX לשעה מקומית בפורמט HH:MM:SS
       * @param {number} unixTimestamp חותמת זמן בפורמט UNIX (שניות)
       * @returns {string} שעה בפורמט HH:MM:SS
       */
      function formatTimeWithSeconds(unixTimestamp) {
        const date = new Date(unixTimestamp * 1000); // ממיר משניות למילישניות
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
      }

      /**
       * יוצר הודעת התרעה קריאה מנתוני ה-API, כולל תאריך.
       * @param {Object} alertData - אובייקט התרעה מה-API.
       * @param {boolean} includeDate - האם לכלול תאריך בהודעה.
       * @returns {string} - מחרוזת ההתרעה המעוצבת.
       */
      function createAlertMessage(alertData, includeDate = false) {
        const date = new Date(alertData.time * 1000);
        const time = formatTimeWithSeconds(alertData.time);
        const threatDesc = THREAT_MAP[alertData.threat] || "איום לא ידוע";
        const cities = alertData.cities && alertData.cities.length > 0 ? alertData.cities.join(', ') : "אזורים שונים";
        const drillStatus = alertData.isDrill ? " - תרגיל" : "";

        let message = `${cities}: ${threatDesc}${drillStatus} (${time})`;
        if (includeDate) {
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0'); // חודשים מ-0
          const year = date.getFullYear();
          message = `${day}/${month}/${year} ${message}`;
        }
        return message;
      }

      /**
       * מוסיף התרעה חדשה לתצוגה הראשית.
       * @param {Object} alertData - אובייקט ההתרעה מה-API.
       */
      function addAlertToDisplay(alertData) {
        if (displayedAlerts.has(alertData.notificationId)) {
          return; // התרעה זו כבר הוצגה
        }

        const message = createAlertMessage(alertData);
        const listItem = document.createElement("li");
        listItem.classList.add("alert-item", "active"); // הוסף קלאס "active"
        listItem.dataset.notificationId = alertData.notificationId;

        listItem.innerHTML = `<div class="alert-text">${message}</div>`;

        // נקה הודעת "אין התרעות" אם קיימת
        const noAlertsEl = document.querySelector('.no-alerts-message');
        if (noAlertsEl) {
          noAlertsEl.remove();
        }

        alertsList.prepend(listItem);
        displayedAlerts.set(alertData.notificationId, listItem);

        // הוסף את הקלאס new-alert להפעלת אנימציית ה-pulse
        listItem.classList.add('new-alert');
        setTimeout(() => {
          listItem.classList.remove('new-alert');
        }, 3000);

        // וודא שלא נציג יותר מדי התרעות - הסר את הישנה ביותר
        while (alertsList.children.length > MAX_ALERTS_DISPLAY) {
          const oldestItem = alertsList.lastChild;
          if (oldestItem && oldestItem.classList.contains('active')) { // וודא שזה פריט התרעה פעיל
              const oldestId = oldestItem.dataset.notificationId;
              oldestItem.style.animation = 'fadeOutAndShrink 0.5s ease-out forwards';
              oldestItem.addEventListener('animationend', () => {
                if (oldestId && displayedAlerts.has(oldestId)) {
                    displayedAlerts.delete(oldestId);
                }
                oldestItem.remove();
                checkAndDisplayNoAlertsMessage(); // בדוק אם צריך להציג הודעת "אין התרעות" אחרי הסרה
              }, { once: true });
          } else {
              // אם ה-lastChild הוא לא פריט התרעה פעיל (למשל, הודעת "אין התרעות"), פשוט הסר אותו
              oldestItem.remove();
          }
        }
      }

      /**
       * מציג הודעת "אין התרעות" אם רשימת ההתרעות ריקה.
       */
      function checkAndDisplayNoAlertsMessage() {
        if (alertsList.children.length === 0 && !document.querySelector('.no-alerts-message')) {
          const noAlertsMessage = document.createElement("li");
          noAlertsMessage.classList.add("no-alerts-message");
          noAlertsMessage.textContent = "אין כרגע התרעות - הכל שקט ובטוח!";
          alertsList.appendChild(noAlertsMessage);
        }
      }

      /**
       * מאחזר את ההתרעות מה-API ומעדכן את התצוגה.
       */
      async function fetchAlerts() {
        try {
          const response = await fetch(ALERTS_API_URL);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
          }
          const alerts = await response.json();

          if (!Array.isArray(alerts)) {
              throw new Error("API response is not an array. Response received:", alerts);
          }

          // שמור את כל ההתרעות שנקלטו לצורך היסטוריה
          alerts.forEach(alert => {
            if (!allFetchedAlerts.some(a => a.notificationId === alert.notificationId)) {
                allFetchedAlerts.push(alert);
            }
          });

          // סנן רק התרעות חדשות או פעילות להצגה
          const activeAlerts = alerts.filter(alert => !displayedAlerts.has(alert.notificationId));

          if (activeAlerts.length > 0) {
            // אם יש התרעות חדשות, נקה את "אין התרעות" וצר אותן
            const noAlertsEl = document.querySelector('.no-alerts-message');
            if (noAlertsEl) {
              noAlertsEl.remove();
            }
            activeAlerts.forEach(alert => addAlertToDisplay(alert));
          } else if (displayedAlerts.size === 0) {
            // אם אין התרעות חדשות ואין התרעות מוצגות, הצג הודעת "אין התרעות"
            checkAndDisplayNoAlertsMessage();
          }

          // הסר התרעות שכבר לא פעילות ב-API מהתצוגה (אם הן היו שם)
          const currentApiIds = new Set(alerts.map(a => a.notificationId));
          for (const [id, element] of displayedAlerts.entries()) {
            if (!currentApiIds.has(id)) {
                element.style.animation = 'fadeOutAndShrink 0.5s ease-out forwards';
                element.addEventListener('animationend', () => {
                    displayedAlerts.delete(id);
                    element.remove();
                    checkAndDisplayNoAlertsMessage(); // בדוק אם צריך להציג הודעת "אין התרעות" אחרי הסרה
                }, { once: true });
            }
          }

        } catch (error) {
          console.error("Error fetching alerts:", error);
          // הצג הודעת שגיאה על המסך כדי שהמשתמש יראה
          const errorLi = document.createElement("li");
          errorLi.classList.add("alert-item");
          errorLi.style.backgroundColor = "#e74c3c"; /* אדום לשגיאה חמורה */
          errorLi.style.fontSize = "1.5em";
          errorLi.style.padding = "15px";
          errorLi.textContent = `שגיאה חמורה: לא ניתן לטעון התרעות (${error.message}). נסה לרענן.`;
          alertsList.innerHTML = '';
          alertsList.appendChild(errorLi);
          displayedAlerts.clear();
        }
      }

      /**
       * מציג את חלון היסטוריית ההתרעות.
       */
      function showHistoryModal() {
        historyList.innerHTML = ''; // נקה את הרשימה הקודמת

        const oneHourAgo = Math.floor(Date.now() / 1000) - (HISTORY_LOOKBACK_HOURS * 60 * 60);

        const recentAlerts = allFetchedAlerts.filter(alert => alert.time >= oneHourAgo)
                                             .sort((a, b) => b.time - a.time); // מהחדש לישן

        if (recentAlerts.length > 0) {
          recentAlerts.forEach(alert => {
            const listItem = document.createElement("li");
            listItem.innerHTML = createAlertMessage(alert, true); // כולל תאריך
            historyList.appendChild(listItem);
          });
        } else {
          const noHistoryMessage = document.createElement("li");
          noHistoryMessage.style.cssText = "text-align: center; color: #aaa;";
          noHistoryMessage.textContent = `אין התרעות בשעה האחרונה.`;
          historyList.appendChild(noHistoryMessage);
        }
        historyModal.style.display = "flex"; // הצג כ-flex כדי למרכז
      }

      /**
       * סוגר את חלון היסטוריית ההתרעות.
       */
      function hideHistoryModal() {
        historyModal.style.display = "none";
      }

      // --- אירועים ---
      historyButton.addEventListener("click", showHistoryModal);
      closeHistoryModalButton.addEventListener("click", hideHistoryModal);
      // סגור את המודאל בלחיצה מחוץ לתוכן
      window.addEventListener("click", (event) => {
        if (event.target == historyModal) {
          hideHistoryModal();
        }
      });

      // --- אתחול והפעלת טיימר ---
      document.addEventListener("DOMContentLoaded", () => {
        // טען התרעות פעם אחת מיד עם טעינת הדף, לפני הצגת האלמנטים
        // זה מבטיח שהנתונים זמינים ברגע שהמסך הראשי מופיע
        fetchAlerts();

        // הסתר את מסך הפתיחה וחשוף את התוכן הראשי לאחר זמן קבוע
        setTimeout(() => {
          splashScreen.classList.add("hidden"); // התחל להסתיר את הספלאש
          fullScreenContainer.classList.add("visible"); // התחל להציג את התוכן הראשי
          historyButton.classList.add("visible"); // התחל להציג את כפתור ההיסטוריה

          // הגדר עדכון אוטומטי רק לאחר שהמסך הראשי גלוי וה-fetch הראשוני בוצע
          setInterval(fetchAlerts, UPDATE_INTERVAL_MS);

          // וודא שהודעת "אין התרעות" מוצגת בהתחלה אם אין התרעות,
          // לאחר שה-fetch הראשוני הסתיים והאלמנטים הראשיים נטענו
          // דיליי קצרצר כדי לאפשר לפונקציית fetchAlerts לרוץ פעם אחת
          setTimeout(() => {
              if (displayedAlerts.size === 0 && !document.querySelector('.no-alerts-message')) {
                  checkAndDisplayNoAlertsMessage();
              }
          }, 500); // 0.5 שניות אחרי סיום הספלאש
        }, SPLASH_SCREEN_DURATION_MS);
      });
    </script>
  </body>
</html>
